## 20200215

[TOC]

### 离线安装Rancher

#### 前言

Rancher是一套容器管理平台，使用它可以轻松的管理各种环境的Kubernetes，并可以在生产环境中快速的部署和管理容器。下文参照Rancher官网，对离线部署Rancher进行了实践。

#### 准备

1. 下载镜像上传到私有仓库（下述所需文件，归档至//10.11）

   * 从Rancher github的发布页面获取对应版本的rancher-images.txt文件
   * 复制以下脚本保存为rancher-save-images.sh

   ```shell
   #!/bin/bash
   # 定义日志
   workdir=`pwd`
   log_file=${workdir}/sync_images_$(date +"%Y-%m-%d").log
   
   logger()
   {
       log=$1
       cur_time='['$(date +"%Y-%m-%d %H:%M:%S")']'
       echo ${cur_time} ${log} | tee -a ${log_file}
   }
   
   list="rancher-images.txt"
   #images="rancher-images.tar.gz"
   
   POSITIONAL=()
   while [[ $# -gt 0 ]]; do
       key="$1"
       case $key in
           -i|--images)
           images="$2"
           shift # past argument
           shift # past value
           ;;
           -l|--image-list)
           list="$2"
           shift # past argument
           shift # past value
           ;;
           -h|--help)
           help="true"
           shift
       ;;
       esac
   done
   
   usage () {
       echo "USAGE: $0 [--image-list rancher-images.txt] [--images rancher-images.tar.gz]"
       echo "  [-l|--images-list path] text file with list of images. 1 per line."
       echo "  [-l|--images path] tar.gz generated by docker save."
       echo "  [-h|--help] Usage message"
   }
   
   if [[ $help ]]; then
       usage
       exit 0
   fi
   
   mkdir -p rancher-images-$(date +"%Y-%m-%d")
   
   for i in $(cat ${list});
   do
       if [[ ! -f rancher-images-$(date +"%Y-%m-%d")/$(echo $i | sed "s#/#-#g; s#:#-#g").tgz ]];then
   
           docker pull ${i}
   
           if [ $? -ne 0 ]; then
               logger "${i} pull failed."
           else
               logger "${i} pull successfully."
           fi
   
           docker save ${i} | gzip > rancher-images-$(date +"%Y-%m-%d")/$(echo $i | sed "s#/#-#g; s#:#-#g").tgz
   
           if [ $? -ne 0 ]; then
               logger "${i} save failed."
           else
               logger "${i} save successfully."
           fi
   
       else
           logger "${i} Images downloaded."
       fi
   done
   ```

   * 复制以下内容保存为rancher-push-images.sh

   ```shell
   #!/bin/bash
   
   ## 镜像上传说明
   # 需要先在镜像仓库中创建 rancher 项目
   # 根据实际情况更改以下私有仓库地址
   
   # 定义日志
   workdir=`pwd`
   log_file=${workdir}/sync_images_$(date +"%Y-%m-%d").log
   
   logger()
   {
       log=$1
       cur_time='['$(date +"%Y-%m-%d %H:%M:%S")']'
       echo ${cur_time} ${log} | tee -a ${log_file}
   }
   
   images_hub() {
   
       while true; do
           read -p "输入镜像仓库地址(不加http/https): " registry
           read -p "输入镜像仓库用户名: " registry_user
           read -p "输入镜像仓库用户密码: " registry_password
           echo "您设置的仓库地址为: ${registry},用户名: ${registry_user},密码: xxx"
           read -p "是否确认(Y/N): " confirm
   
           if [ $confirm != Y ] && [ $confirm != y ] && [ $confirm == '' ]; then
               echo "输入不能为空，重新输入"
           else
               break
           fi
       done
   }
   
   images_hub
   
   echo "镜像仓库 $(docker login -u ${registry_user} -p ${registry_password} ${registry})"
   
   #images=$(docker images -a | grep -v TAG | awk '{print $1 ":" $2}')
   
   images=$(cat rancher-images.txt )
   
   # 定义全局项目，如果想把镜像全部同步到一个仓库，则指定一个全局项目名称；
   global_namespace=   # rancher
   
   docker_push() {
       for imgs in $(echo ${images}); do
           if [[ -n "$global_namespace" ]]; then
   
               n=$(echo ${imgs} | awk -F"/" '{print NF-1}')
               # 如果镜像名中没有/，那么此镜像一定是library仓库的镜像；
               if [ ${n} -eq 0 ]; then
                   img_tag=${imgs}
   
                   #重命名镜像
                   docker tag ${imgs} ${registry}/${global_namespace}/${img_tag}
   
                   #删除原始镜像
                   #docker rmi ${imgs}
                   #上传镜像
                   docker push ${registry}/${global_namespace}/${img_tag}
   
               # 如果镜像名中有一个/，那么/左侧为项目名，右侧为镜像名和tag
               elif [ ${n} -eq 1 ]; then
                   img_tag=$(echo ${imgs} | awk -F"/" '{print $2}')
   
                   #重命名镜像
                   docker tag ${imgs} ${registry}/${global_namespace}/${img_tag}
                   #删除旧镜像
                   #docker rmi ${imgs}
                   #上传镜像
                   docker push ${registry}/${global_namespace}/${img_tag}
   
               # 如果镜像名中有两个/，
               elif [ ${n} -eq 2 ]; then
                   img_tag=$(echo ${imgs} | awk -F"/" '{print $3}')
   
                   #重命名镜像
                   docker tag ${imgs} ${registry}/${global_namespace}/${img_tag}
                   #删除旧镜像
                   #docker rmi ${imgs}
                   #上传镜像
                   docker push ${registry}/${global_namespace}/${img_tag}
               else
                   #标准镜像为四层结构，即：仓库地址/项目名/镜像名:tag,如不符合此标准，即为非有效镜像。
                   echo "No available images"
               fi
           else
   
               n=$(echo ${imgs} | awk -F"/" '{print NF-1}')
               # 如果镜像名中没有/，那么此镜像一定是library仓库的镜像；
               if [ ${n} -eq 0 ]; then
                   img_tag=${imgs}
                   namespace=library
                   #重命名镜像
                   docker tag ${imgs} ${registry}/${namespace}/${img_tag}
                   #删除原始镜像
                   #docker rmi ${imgs}
                   #上传镜像
                   docker push ${registry}/${namespace}/${img_tag}
   
               # 如果镜像名中有一个/，那么/左侧为项目名，右侧为镜像名和tag
               elif [ ${n} -eq 1 ]; then
                   img_tag=$(echo ${imgs} | awk -F"/" '{print $2}')
                   namespace=$(echo ${imgs} | awk -F"/" '{print $1}')
   
                   #重命名镜像
                   docker tag ${imgs} ${registry}/${namespace}/${img_tag}
                   #删除旧镜像
                   #docker rmi ${imgs}
                   #上传镜像
                   docker push ${registry}/${namespace}/${img_tag}
   
               # 如果镜像名中有两个/，
               elif [ ${n} -eq 2 ]; then
                   img_tag=$(echo ${imgs} | awk -F"/" '{print $3}')
                   namespace=$(echo ${imgs} | awk -F"/" '{print $2}')
   
                   #重命名镜像
                   docker tag ${imgs} ${registry}/${namespace}/${img_tag}
                   #删除旧镜像
                   #docker rmi ${imgs}
                   #上传镜像
                   docker push ${registry}/${namespace}/${img_tag}
               else
                   #标准镜像为四层结构，即：仓库地址/项目名/镜像名:tag,如不符合此标准，即为非有效镜像。
                   echo "No available images"
               fi
   
           fi
       done
   }
   
   docker_push
   ```

   * 将上述三个文件上传到一台在可访问internet的主机中，执行如下命令

   ```shell
   # 执行rancher-save-images.sh脚本，结果会在目录rancher-images-$(date +"%Y-%m-%d")中生成所有镜像的压缩文件
   chmod +x ./rancher-save-images.sh
   ./rancher-save-images.sh --image-list ./rancher-images.txt
   
   # 执行rancher-push-images.sh脚本，输入私有仓库的地址（这里使用174 Harbor仓库）
   chmod +x ./rancher-push-images.sh
   ./rancher-push-images.sh
   
   ```

2. 机器以及软件准备

   准备四台机器

   - rancher-client：10.6.209.11
   - rancher-node1：10.6.209.26
   - rancher-node2：10.6.209.27
   - rancher-node3：10.6.209.28

   准备相应的软件

   * kubectl：Kubernetes命令行工具
   * rke：Rancher Kubernetes Engine，用于构建Kubernetes集群的cli
   * helm：Kubernetes的包管理

### RKE安装k8s

1. 安装docker

```shell
# 分别登录rancher-node1，rancher-node2，rancher-node3 执行如下命令

# 基于安全考虑，创建非root用户管理Docker
useradd rancher
passwd rancher
groupadd docker
usermod -aG docker rancher

```

2. 配置ssh免密码登录

```shell
# 在rancher-client所在主机上创建秘钥
ssh-keygen

# 将所生成的密钥的公钥分发到各个节点
ssh-copy-id rancher@10.6.209.26
ssh-copy-id rancher@10.6.209.27
ssh-copy-id rancher@10.6.209.28
```

3. 创建RKE配置文件

4. 创建kubernetes集群
5. 测试集群

### 安装Rancher

1. 安装Helm，并初始化helm
2. 获取charts模板，并安装







