### 20200909

[TOC]

https://livebook.manning.com/book/gitops-and-kubernetes/chapter-1/v-6/26

### GitOps是什么？

GitOps是对基础架构即代码（IaC）这一概念的阐述。GitOps弥补了现有DevOps技术与分布式、云托管应用的特殊需求之间的关键差距。

其核心思想是将应用系统的声明性基础架构和应用程序存放在Git的版本控制库中。

当开发人员更改应用程序时，Git将自动把它们push到Kubernetes进行部署。如果Kubernetes内的运行状态发生变化但与Git内的状态不一致，则它们会从Git内恢复到已知状态。



我们必须确保改变集群的唯一方法是在Git仓库上提交。



![img](pics/GitOps_20200909/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_15996376995039.png)



### GitOps流程

- 一个开发者为一个新功能提出Git 拉取请求
- 审查和批准代码，然后将其合并到主代码库中
- 合并会触发 CI/CD 流水线、自动测试和重建新代码，并将其部署到仓库
- 软件代理注意到更新，从仓库中提取新代码，并更新配置仓库中的配置文件（用YAML编写）
- Kubernetes集群中的软件代理根据配置文件，检测到集群已经过时，拉取更改，并部署新功能



部署到仓库是什么意思？

软件代理是什么东西？配置仓库是另外一种仓库？



应用程序的典型生命周期包括：

- 代码
- 构建
- 创建镜像
- 测试
- 发布

而使用GitOps，这些状态将会扩展为：

- 部署
- 在Git仓库中监控更改

- 日志更改和事件
- 发生更改时发出警报，并于现有的监控/告警系统集成
- 更新

### GitOps优势

- 可观察性：GitOps系统为复杂的应用提供了监控、日志、跟踪和可视化功能，因此开发人员可以看到什么地方出现了故障，在哪里出现了故障
- 版本控制和变更管理：有缺陷的更新可以轻松回滚
- 易于采用
- 提高生产力：GitOps 可以像开发项目和 CI/CD 那样提高工作效率
- 审计：有了Git，每一个操作都可以追踪到一个特定的提交，这样就可以很容易地追踪到错误的原因

### 实践

还是看下具体实践，感觉说得有点云里雾里。

即：

1. 将所有Kubernetes资源配置存储在Git中
2. 只使用PR来修改该Git仓库上的资源
3. 一旦修改了Git，立即将更改应用到集群中，并且完全自动化
4. 如果实际状态与所需的状态有偏差，要么纠正它，要么提醒操作人员



GitOps将允许我们将应用的持续集成（CI）流程与部署流程分开，因为部署流程将根据**环境仓库**的变化而不是作为CI流程的一部分来启动。



**FluxCD**是这样一个很棒的工具，它可以将Git和K8s集成起来。它的重要功能是监视远程Git仓库来应用k8s清单中的更改（将Git仓库中的清单状态与集群中运行的内容同步，也可以通过fluxctl sync命令手动触发）。该工具专注于软件交付周期中的部署部分。



示例中举了两个例子。

deployment manifest配置文件的更改，会自动触发环境的更新



升级容器镜像并同步。对Docker镜像进行修改并将其上传到我们的Docker Hub镜像仓库中。修改main.py文件，创建一个新的Docker文件并上传到Docker，然后Flux将会自动部署新镜像。？监控的是什么呢？源码仓库？

`fluxctl automate`或者在工作负载的部署清单中添加注释，来开启这个功能，它会轮询镜像仓库中镜像元数据，如果有新版本，它可以使用新的版本来更新部署。并且，这样Flux会写一个提交到原始Git仓库，更新清单中使用的镜像版本，因此Git仍然是集群中运行的内容的真实来源。



仓库的要求是怎么样的？多环境多个仓库？



**ArgoCD**也是一个非常出色的Kubernetes声明性GitOps持续交付（CD）工具。