## 20191202

[TOC]

### secret

之前有了解过ConfigMap,一般ConfigMap用来存储一些非安全的配置信息，如果涉及到一些安全相关的数据的话，就需要用到另外一个资源对象了Secret, Secret用来保存密码，令牌，ssh key等敏感信息。

有三种类型：

* Opaque：base64编码格式的Secret，用来存储密码、密钥
* dockerconfigjson：docker registry 认证的Secret
* service-account-token：用于被serviceaccount引用

 #### Opaque Secret

比如用户名和密码，使用base64加密

```
echo -n "admin" | base64
YW1kaW4=
echo -n "admin321" | base64
YWRtaW4zMjE=
```

然后编写YAML文件

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysecret
type: Opaque
data:
  username: YWRtaW4=
  password: YWRtaW4zMjE=
```

使用kubectl create命令创建

```
kubectl create -f secret-demo.yaml

# 其它一些命令
kubectl get secret mysecret -o yaml
kubectl describe secret mysecret
```

创建好Secret对象后，使用如下两种方式来使用它

* 环境变量方式
* Volume的形式挂载

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret1-pod
spec:
  containers:
  - name: secret1
    image: busybox
    command: ["/bin/sh", "-c", "env"]
    env:
    - name: USERNAME
      valueFrom:
        secretKeyRef:
          name: mysecret
          key: username
    - name: PASSWORD
      valueFrom:
        secretKeyRef:
          name: mysecret
          key: password
```

```yaml
kubectl logs secret1-pod
PASSWORD=admin321
USERNAME=admin
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret2-pod
spec:
  containers:
  - name: secret2
    image: busybox
    command: ["/bin/sh", "-c", "ls /etc/secrets"]
    volumeMounts:
    - name: secrets
      mountPath: /etc/secrets
  volumes:
    - name: secrets
      secret:
        secretName: mysecret
```

```
kubectl logs secret2-pod
password
username
```

secret 把两个key挂载成了两个对应的⽂件。

还有个例子可以试试

#### dockerconfigjson

```
kubectl create secret docker-registry myregistry --docker-server=DOCKER_SERVER --dockerusername=
DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL
```

使用在imagePullSecrets上

```
imagePullSecrets:
- name: myregistrykey
```

#### service-account-token

被serviceaccount引用，Pod 如果使⽤了 serviceaccount，对应的secret会⾃动挂载到Pod的 /run/secrets/kubernetes.io/serviceaccount ⽬录中。

### Secret与ConfigMap对比

相同点：

* kye/value的形式
* 可以导出到环境变量
* 可以通过目录/文件形式挂载
* 通过volume挂载的配置信息均可以热更新

不同点：

* Secret可以被ServerAccount关联
* Secret 可以存储 docker register 的鉴权信息，⽤在 ImagePullSecret 参数中，⽤于拉取私有仓库
  的镜像
* Secret 分为 kubernetes.io/service-account-token、kubernetes.io/dockerconfigjson、Opaque 三
  种类型，⽽ Configmap 不区分类型
* Secret ⽀持 Base64 加密

